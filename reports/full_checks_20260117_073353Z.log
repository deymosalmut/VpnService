==================================================
[RUN] /opt/vpn-service/scripts/checks/01_env.sh
----------------------------------------
[INFO] ENV CHECK
[INFO] OS: Linux Vpn-Main 6.8.0-90-generic #91-Ubuntu SMP PREEMPT_DYNAMIC Tue Nov 18 14:14:30 UTC 2025 x86_64 x86_64 x86_64 GNU/Linux
[INFO] dotnet: 9.0.203
[INFO] curl: curl 8.5.0 (x86_64-pc-linux-gnu) libcurl/8.5.0 OpenSSL/3.0.13 zlib/1.3 brotli/1.1.0 zstd/1.5.5 libidn2/2.3.7 libpsl/0.21.2 (+libidn2/2.3.7) libssh/0.10.6/openssl/zlib nghttp2/1.59.0 librtmp/2.3 OpenLDAP/2.6.7
[INFO] wg: wireguard-tools v1.0.20210914 - https://git.zx2c4.com/wireguard-tools/
[INFO] psql: psql (PostgreSQL) 15.15 (Ubuntu 15.15-1.pgdg24.04+1)
----------------------------------------
[INFO] OK
[RC ] 0 (/opt/vpn-service/scripts/checks/01_env.sh)
==================================================
[RUN] /opt/vpn-service/scripts/checks/02_services.sh
----------------------------------------
[INFO] SERVICES CHECK
[WARN] ssh: unit not found
[WARN] postgresql: unit not found
[WARN] wg-quick@wg1: unit not found
----------------------------------------
[INFO] OK (with possible warnings)
[RC ] 0 (/opt/vpn-service/scripts/checks/02_services.sh)
==================================================
[RUN] /opt/vpn-service/scripts/checks/03_wireguard.sh
----------------------------------------
[INFO] WIREGUARD CHECK
[INFO] Interfaces:
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000
2: enp0s3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP mode DEFAULT group default qlen 1000
3: enp0s8: <BROADCAST,MULTICAST> mtu 1500 qdisc noop state DOWN mode DEFAULT group default qlen 1000
4: wg1: <POINTOPOINT,NOARP,UP,LOWER_UP> mtu 1420 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000
5: docker0: <NO-CARRIER,BROADCAST,MULTICAST,UP> mtu 1500 qdisc noqueue state DOWN mode DEFAULT group default 
----------------------------------------
[INFO] wg show wg1:
interface: wg1
  public key: ZYXEy5Xnr+8yTjisbjgyaLGzvDBqvPtcY6A/EFEAk0U=
  private key: (hidden)
  listening port: 51820

peer: QJh6h5iG80A3kvfmP46RvSR1ddBDOWV+6lMU04tNUBY=
  allowed ips: 10.8.0.100/32
----------------------------------------
[INFO] wg dump wg1:
oPRJJkT7yzF4bx1JuLtnKfQrQLfiJ3NhIkGUt+8Py2k=	ZYXEy5Xnr+8yTjisbjgyaLGzvDBqvPtcY6A/EFEAk0U=	51820	off
QJh6h5iG80A3kvfmP46RvSR1ddBDOWV+6lMU04tNUBY=	(none)	(none)	10.8.0.100/32	0	0	0	off
----------------------------------------
[INFO] OK
[RC ] 0 (/opt/vpn-service/scripts/checks/03_wireguard.sh)
==================================================
[RUN] /opt/vpn-service/scripts/checks/04_db.sh
----------------------------------------
[INFO] DB CHECK
[INFO] postgresql: active
----------------------------------------
sudo: unable to resolve host Vpn-Main: Name or service not known
                                                      Список баз данных
    Имя     |  Владелец  | Кодировка | LC_COLLATE  |  LC_CTYPE   | локаль ICU | Провайдер локали |       Права доступа       
------------+------------+-----------+-------------+-------------+------------+------------------+---------------------------
 postgres   | postgres   | UTF8      | en_US.UTF-8 | en_US.UTF-8 |            | libc             | 
 template0  | postgres   | UTF8      | en_US.UTF-8 | en_US.UTF-8 |            | libc             | =c/postgres              +
            |            |           |             |             |            |                  | postgres=CTc/postgres
 template1  | postgres   | UTF8      | en_US.UTF-8 | en_US.UTF-8 |            | libc             | =c/postgres              +
            |            |           |             |             |            |                  | postgres=CTc/postgres
 vpnservice | vpnservice | UTF8      | en_US.UTF-8 | en_US.UTF-8 |            | libc             | =Tc/vpnservice           +
            |            |           |             |             |            |                  | vpnservice=CTc/vpnservice+
            |            |           |             |             |            |                  | vpn_admin=CTc/vpnservice +
            |            |           |             |             |            |                  | vpnuser=CTc/vpnservice
(4 строки)

----------------------------------------
[INFO] OK (with possible warnings)
[RC ] 0 (/opt/vpn-service/scripts/checks/04_db.sh)
==================================================
[RUN] /opt/vpn-service/scripts/checks/05_build.sh
----------------------------------------
[INFO] BUILD CHECK
[INFO] dotnet restore...
  Определение проектов для восстановления...
  Все проекты обновлены для восстановления.
[INFO] dotnet build...
  Определение проектов для восстановления...
  Все проекты обновлены для восстановления.
  VpnService.Domain -> /opt/vpn-service/VpnService.Domain/bin/Debug/net9.0/VpnService.Domain.dll
  VpnService.Infrastructure.Abstractions -> /opt/vpn-service/VpnService.Infrastructure.Abstractions/bin/Debug/net9.0/VpnService.Infrastructure.Abstractions.dll
  VpnService.Application -> /opt/vpn-service/VpnService.Application/bin/Debug/net9.0/VpnService.Application.dll
  VpnService.Infrastructure -> /opt/vpn-service/VpnService.Infrastructure/bin/Debug/net9.0/VpnService.Infrastructure.dll
  VpnService.Api -> /opt/vpn-service/VpnService.Api/bin/Debug/net9.0/VpnService.Api.dll

Сборка успешно завершена.
    Предупреждений: 0
    Ошибок: 0

Прошло времени 00:00:03.24
----------------------------------------
[INFO] OK
[RC ] 0 (/opt/vpn-service/scripts/checks/05_build.sh)
==================================================
[RUN] /opt/vpn-service/scripts/checks/06_run_api.sh
----------------------------------------
[INFO] RUN API (foreground)
[INFO] API_BASE_URL=http://127.0.0.1:5272
[INFO] Press Ctrl+C to stop
Используются параметры запуска из VpnService.Api/Properties/launchSettings.json...
Сборка…
[07:34:09 INF] Saved 0 entities to in-memory store.
[07:34:09 INF] In-memory database created successfully
[07:34:09 INF] VPN Service starting...
[07:34:09 INF] User profile is available. Using '/root/.aspnet/DataProtection-Keys' as key repository; keys will not be encrypted at rest.
[07:34:09 ERR] Hosting failed to start
System.IO.IOException: Failed to bind to address http://127.0.0.1:5272: address already in use.
 ---> Microsoft.AspNetCore.Connections.AddressInUseException: Address already in use
 ---> System.Net.Sockets.SocketException (98): Address already in use
   at System.Net.Sockets.Socket.DoBind(EndPoint endPointSnapshot, SocketAddress socketAddress)
   at System.Net.Sockets.Socket.Bind(EndPoint localEP)
   at Microsoft.AspNetCore.Server.Kestrel.Transport.Sockets.SocketTransportOptions.CreateDefaultBoundListenSocket(EndPoint endpoint)
   at Microsoft.AspNetCore.Server.Kestrel.Transport.Sockets.SocketConnectionListener.Bind()
   --- End of inner exception stack trace ---
   at Microsoft.AspNetCore.Server.Kestrel.Transport.Sockets.SocketConnectionListener.Bind()
   at Microsoft.AspNetCore.Server.Kestrel.Transport.Sockets.SocketTransportFactory.BindAsync(EndPoint endpoint, CancellationToken cancellationToken)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Infrastructure.TransportManager.BindAsync(EndPoint endPoint, ConnectionDelegate connectionDelegate, EndpointConfig endpointConfig, CancellationToken cancellationToken)
   at Microsoft.AspNetCore.Server.Kestrel.Core.KestrelServerImpl.<>c__DisplayClass28_0`1.<<StartAsync>g__OnBind|0>d.MoveNext()
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.AddressBinder.BindEndpointAsync(ListenOptions endpoint, AddressBindContext context, CancellationToken cancellationToken)
   --- End of inner exception stack trace ---
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.AddressBinder.BindEndpointAsync(ListenOptions endpoint, AddressBindContext context, CancellationToken cancellationToken)
   at Microsoft.AspNetCore.Server.Kestrel.Core.LocalhostListenOptions.BindAsync(AddressBindContext context, CancellationToken cancellationToken)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.AddressBinder.AddressesStrategy.BindAsync(AddressBindContext context, CancellationToken cancellationToken)
   at Microsoft.AspNetCore.Server.Kestrel.Core.KestrelServerImpl.BindAsync(CancellationToken cancellationToken)
   at Microsoft.AspNetCore.Server.Kestrel.Core.KestrelServerImpl.StartAsync[TContext](IHttpApplication`1 application, CancellationToken cancellationToken)
   at Microsoft.AspNetCore.Hosting.GenericWebHostService.StartAsync(CancellationToken cancellationToken)
   at Microsoft.Extensions.Hosting.Internal.Host.<StartAsync>b__14_1(IHostedService service, CancellationToken token)
   at Microsoft.Extensions.Hosting.Internal.Host.ForeachService[T](IEnumerable`1 services, CancellationToken token, Boolean concurrent, Boolean abortOnFirstException, List`1 exceptions, Func`3 operation)
Unhandled exception. System.IO.IOException: Failed to bind to address http://127.0.0.1:5272: address already in use.
 ---> Microsoft.AspNetCore.Connections.AddressInUseException: Address already in use
 ---> System.Net.Sockets.SocketException (98): Address already in use
   at System.Net.Sockets.Socket.DoBind(EndPoint endPointSnapshot, SocketAddress socketAddress)
   at System.Net.Sockets.Socket.Bind(EndPoint localEP)
   at Microsoft.AspNetCore.Server.Kestrel.Transport.Sockets.SocketTransportOptions.CreateDefaultBoundListenSocket(EndPoint endpoint)
   at Microsoft.AspNetCore.Server.Kestrel.Transport.Sockets.SocketConnectionListener.Bind()
   --- End of inner exception stack trace ---
   at Microsoft.AspNetCore.Server.Kestrel.Transport.Sockets.SocketConnectionListener.Bind()
   at Microsoft.AspNetCore.Server.Kestrel.Transport.Sockets.SocketTransportFactory.BindAsync(EndPoint endpoint, CancellationToken cancellationToken)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Infrastructure.TransportManager.BindAsync(EndPoint endPoint, ConnectionDelegate connectionDelegate, EndpointConfig endpointConfig, CancellationToken cancellationToken)
   at Microsoft.AspNetCore.Server.Kestrel.Core.KestrelServerImpl.<>c__DisplayClass28_0`1.<<StartAsync>g__OnBind|0>d.MoveNext()
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.AddressBinder.BindEndpointAsync(ListenOptions endpoint, AddressBindContext context, CancellationToken cancellationToken)
   --- End of inner exception stack trace ---
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.AddressBinder.BindEndpointAsync(ListenOptions endpoint, AddressBindContext context, CancellationToken cancellationToken)
   at Microsoft.AspNetCore.Server.Kestrel.Core.LocalhostListenOptions.BindAsync(AddressBindContext context, CancellationToken cancellationToken)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.AddressBinder.AddressesStrategy.BindAsync(AddressBindContext context, CancellationToken cancellationToken)
   at Microsoft.AspNetCore.Server.Kestrel.Core.KestrelServerImpl.BindAsync(CancellationToken cancellationToken)
   at Microsoft.AspNetCore.Server.Kestrel.Core.KestrelServerImpl.StartAsync[TContext](IHttpApplication`1 application, CancellationToken cancellationToken)
   at Microsoft.AspNetCore.Hosting.GenericWebHostService.StartAsync(CancellationToken cancellationToken)
   at Microsoft.Extensions.Hosting.Internal.Host.<StartAsync>b__14_1(IHostedService service, CancellationToken token)
   at Microsoft.Extensions.Hosting.Internal.Host.ForeachService[T](IEnumerable`1 services, CancellationToken token, Boolean concurrent, Boolean abortOnFirstException, List`1 exceptions, Func`3 operation)
   at Microsoft.Extensions.Hosting.Internal.Host.StartAsync(CancellationToken cancellationToken)
   at Microsoft.Extensions.Hosting.HostingAbstractionsHostExtensions.RunAsync(IHost host, CancellationToken token)
   at Microsoft.Extensions.Hosting.HostingAbstractionsHostExtensions.RunAsync(IHost host, CancellationToken token)
   at Microsoft.Extensions.Hosting.HostingAbstractionsHostExtensions.Run(IHost host)
   at Program.<Main>$(String[] args) in /opt/vpn-service/VpnService.Api/Program.cs:line 125
[RC ] 134 (/opt/vpn-service/scripts/checks/06_run_api.sh)
[STOP] Failed on /opt/vpn-service/scripts/checks/06_run_api.sh
