----------------------------------------------------------------
>>> Stage 3.5 — DIFF/PLAN (read-only)
----------------------------------------------------------------
DESIRED_FILE=/opt/vpn-service/reports/stage35_desired_2026-01-06_14-36-14.tsv
ACTUAL_FILE=/opt/vpn-service/reports/stage35_actual_2026-01-06_14-36-14.tsv
----------------------------------------------------------------
>>> Compute plan
----------------------------------------------------------------
----------------------------------------------------------------
>>> plan build (REMOVE-ONLY if desired incomplete)
----------------------------------------------------------------
+ CMD: bash -lc 
    set -Eeuo pipefail
    desired='/opt/vpn-service/reports/stage35_desired_2026-01-06_14-36-14.tsv'
    actual='/opt/vpn-service/reports/stage35_actual_2026-01-06_14-36-14.tsv'
    plan='/opt/vpn-service/reports/stage35_plan_2026-01-06_14-36-31.tsv'
    diff='/opt/vpn-service/reports/stage35_diff_2026-01-06_14-36-31.txt'
    incomplete='YES'

    awk -F'	' 'NF>=1{print $1}' "$desired" | sed '/^\s*$/d' | sort -u > /tmp/s35_d_$$.txt
    awk -F'	' 'NF>=1{print $1}' "$actual"  | sed '/^\s*$/d' | sort -u > /tmp/s35_a_$$.txt

    # Always safe: peers present in WG but absent in DB => REMOVE
    comm -13 /tmp/s35_d_$$.txt /tmp/s35_a_$$.txt | awk '{print "REMOVE	"$1}' > "$plan" || true

    rem=$(wc -l <"$plan" | tr -d ' ')
    add=0; upd=0; dis=0
    if [[ "$incomplete" == "YES" ]]; then
      echo "SUMMARY remove=$rem (REMOVE-ONLY mode; desired lacks allowed_ips)" > "$diff"
      echo "PLAN_FILE=$plan"
      echo "DIFF_FILE=$diff"
      echo "ADD=$add REMOVE=$rem UPDATE=$upd DISABLE=$dis TOTAL_CHANGES=$rem"
      if [[ $rem -gt 0 ]]; then echo "CHANGES_PENDING=YES"; exit 20; else echo "CHANGES_PENDING=NO"; exit 0; fi
    fi

    # If someday desired becomes complete, we’ll extend ADD/UPDATE here.
    echo "SUMMARY remove=$rem" > "$diff"
    echo "PLAN_FILE=$plan"
    echo "DIFF_FILE=$diff"
    echo "ADD=$add REMOVE=$rem UPDATE=$upd DISABLE=$dis TOTAL_CHANGES=$rem"
    if [[ $rem -gt 0 ]]; then echo "CHANGES_PENDING=YES"; exit 20; else echo "CHANGES_PENDING=NO"; exit 0; fi
  
PLAN_FILE=/opt/vpn-service/reports/stage35_plan_2026-01-06_14-36-31.tsv
DIFF_FILE=/opt/vpn-service/reports/stage35_diff_2026-01-06_14-36-31.txt
ADD=0 REMOVE=0 UPDATE=0 DISABLE=0 TOTAL_CHANGES=0
CHANGES_PENDING=NO
STATUS: OK (exit=0)
----------------------------------------------------------------
>>> Artifacts
----------------------------------------------------------------
PLAN_FILE=/opt/vpn-service/reports/stage35_plan_2026-01-06_14-36-31.tsv
DIFF_FILE=/opt/vpn-service/reports/stage35_diff_2026-01-06_14-36-31.txt
INCOMPLETE_DESIRED=YES
----------------------------------------------------------------
>>> Summary
----------------------------------------------------------------
RESULT=NO_CHANGES
