----------------------------------------------------------------
>>> Stage 3.4 — MIGRATIONS APPLY (controlled)
----------------------------------------------------------------
----------------------------------------------------------------
>>> Load app DB env (normalize PG_DB/PG_DATABASE)
----------------------------------------------------------------
+ CMD: bash -lc 
    cd '/opt/vpn-service'
    source scripts/lib/appdb.sh
    load_app_db_env '/opt/vpn-service/infra/local/app-db.env'
    echo "PG_HOST=$PG_HOST PG_PORT=$PG_PORT PG_DATABASE=$PG_DATABASE PG_USER=$PG_USER PG_PASSWORD=${PG_PASSWORD:+SET}"
  
PG_HOST=127.0.0.1 PG_PORT=5432 PG_DATABASE=vpnservice PG_USER=vpnservice PG_PASSWORD=SET
STATUS: OK (exit=0)
----------------------------------------------------------------
>>> dotnet ef --version
----------------------------------------------------------------
+ CMD: bash -lc cd '/opt/vpn-service' && dotnet ef --version
Entity Framework Core .NET Command-line Tools
9.0.11
STATUS: OK (exit=0)
----------------------------------------------------------------
>>> DB app connect: SELECT 1
----------------------------------------------------------------
+ CMD: bash -lc 
    cd '/opt/vpn-service'
    source scripts/lib/appdb.sh
    load_app_db_env '/opt/vpn-service/infra/local/app-db.env'
    psql_app -Atc 'select 1;'
  
1
STATUS: OK (exit=0)
----------------------------------------------------------------
>>> SAFETY GATE
----------------------------------------------------------------
Target DB: vpnservice @ 127.0.0.1:5432 user=vpnservice
Type APPLY to continue.
----------------------------------------------------------------
>>> EF database update (apply migrations)
----------------------------------------------------------------
+ CMD: bash -lc 
    set -Eeuo pipefail
    cd '/opt/vpn-service'
    source scripts/lib/appdb.sh
    load_app_db_env '/opt/vpn-service/infra/local/app-db.env'
    CONN="$(app_conn_str)"
    echo "Using connection: Host=$PG_HOST;Port=$PG_PORT;Database=$PG_DATABASE;Username=$PG_USER;Password=***"
    dotnet ef database update --project './VpnService.Infrastructure/VpnService.Infrastructure.csproj' --startup-project './VpnService.Infrastructure/VpnService.Infrastructure.csproj' --no-build --connection "$CONN"
  
Using connection: Host=127.0.0.1;Port=5432;Database=vpnservice;Username=vpnservice;Password=***
Failed executing DbCommand (29ms) [Parameters=[], CommandType='Text', CommandTimeout='30']
SELECT "MigrationId", "ProductVersion"
FROM "__EFMigrationsHistory"
ORDER BY "MigrationId";
System.InvalidOperationException: An error was generated for warning 'Microsoft.EntityFrameworkCore.Migrations.PendingModelChangesWarning': The model for context 'VpnDbContext' has pending changes. Add a new migration before updating the database. This exception can be suppressed or logged by passing event ID 'RelationalEventId.PendingModelChangesWarning' to the 'ConfigureWarnings' method in 'DbContext.OnConfiguring' or 'AddDbContext'.
   at Microsoft.EntityFrameworkCore.Diagnostics.EventDefinition`1.Log[TLoggerCategory](IDiagnosticsLogger`1 logger, TParam arg)
   at Microsoft.EntityFrameworkCore.Diagnostics.RelationalLoggerExtensions.PendingModelChangesWarning(IDiagnosticsLogger`1 diagnostics, Type contextType)
   at Microsoft.EntityFrameworkCore.Migrations.Internal.Migrator.Migrate(String targetMigration)
   at Npgsql.EntityFrameworkCore.PostgreSQL.Migrations.Internal.NpgsqlMigrator.Migrate(String targetMigration)
   at Microsoft.EntityFrameworkCore.Design.Internal.MigrationsOperations.UpdateDatabase(String targetMigration, String connectionString, String contextType)
   at Microsoft.EntityFrameworkCore.Design.OperationExecutor.UpdateDatabaseImpl(String targetMigration, String connectionString, String contextType)
   at Microsoft.EntityFrameworkCore.Design.OperationExecutor.UpdateDatabase.<>c__DisplayClass0_0.<.ctor>b__0()
   at Microsoft.EntityFrameworkCore.Design.OperationExecutor.OperationBase.Execute(Action action)
An error was generated for warning 'Microsoft.EntityFrameworkCore.Migrations.PendingModelChangesWarning': The model for context 'VpnDbContext' has pending changes. Add a new migration before updating the database. This exception can be suppressed or logged by passing event ID 'RelationalEventId.PendingModelChangesWarning' to the 'ConfigureWarnings' method in 'DbContext.OnConfiguring' or 'AddDbContext'.
STATUS: FAIL (exit=1)
----------------------------------------------------------------
>>> DB applied migrations after apply
----------------------------------------------------------------
+ CMD: bash -lc 
    cd '/opt/vpn-service'
    source scripts/lib/appdb.sh
    load_app_db_env '/opt/vpn-service/infra/local/app-db.env'
    psql_app -Atc 'select migrationid from "__EFMigrationsHistory" order by migrationid;'
  
ERROR:  relation "__EFMigrationsHistory" does not exist
СТРОКА 1: select migrationid from "__EFMigrationsHistory" order by mig...
                                  ^
STATUS: FAIL (exit=1)
----------------------------------------------------------------
>>> DONE
----------------------------------------------------------------
