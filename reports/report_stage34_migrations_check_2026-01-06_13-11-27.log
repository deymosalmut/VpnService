----------------------------------------------------------------
>>> Stage 3.4 â€” MIGRATIONS CHECK
----------------------------------------------------------------
----------------------------------------------------------------
>>> Load app DB env (normalize PG_DB/PG_DATABASE)
----------------------------------------------------------------
+ CMD: bash -lc 
    cd '/opt/vpn-service'
    source scripts/lib/appdb.sh
    load_app_db_env '/opt/vpn-service/infra/local/app-db.env'
    echo "PG_HOST=$PG_HOST PG_PORT=$PG_PORT PG_DATABASE=$PG_DATABASE PG_USER=$PG_USER PG_PASSWORD=${PG_PASSWORD:+SET}"
  
PG_HOST=127.0.0.1 PG_PORT=5432 PG_DATABASE=vpnservice PG_USER=vpnservice PG_PASSWORD=SET
STATUS: OK (exit=0)
----------------------------------------------------------------
>>> dotnet ef --version
----------------------------------------------------------------
+ CMD: bash -lc cd '/opt/vpn-service' && dotnet ef --version
Entity Framework Core .NET Command-line Tools
9.0.11
STATUS: OK (exit=0)
----------------------------------------------------------------
>>> DB app connect: SELECT 1
----------------------------------------------------------------
+ CMD: bash -lc 
    cd '/opt/vpn-service'
    source scripts/lib/appdb.sh
    load_app_db_env '/opt/vpn-service/infra/local/app-db.env'
    psql_app -Atc 'select 1;'
  
1
STATUS: OK (exit=0)
----------------------------------------------------------------
>>> EF migrations list (informational; WARN-only if fails)
----------------------------------------------------------------
+ CMD: bash -lc 
    set +e
    cd '/opt/vpn-service'
    source scripts/lib/appdb.sh
    load_app_db_env '/opt/vpn-service/infra/local/app-db.env'
    dotnet ef migrations list --project './VpnService.Infrastructure/VpnService.Infrastructure.csproj' --startup-project './VpnService.Infrastructure/VpnService.Infrastructure.csproj' --context 'VpnDbContext' --no-build
    exit 0
  
20260106130133_Initial_20260106_130108
STATUS: OK (exit=0)
----------------------------------------------------------------
>>> Compute pending + generate idempotent SQL if needed
----------------------------------------------------------------
----------------------------------------------------------------
>>> Compute pending
----------------------------------------------------------------
+ CMD: bash -lc 
    set -Eeuo pipefail
    cd '/opt/vpn-service'
    source scripts/lib/appdb.sh
    load_app_db_env '/opt/vpn-service/infra/local/app-db.env'

    src=/tmp/ef_src_11560.txt
    db=/tmp/ef_db_11560.txt
    pending=/tmp/ef_pending_11560.txt

    # Source migrations (strip '(Pending)' marker)
    dotnet ef migrations list --project './VpnService.Infrastructure/VpnService.Infrastructure.csproj' --startup-project './VpnService.Infrastructure/VpnService.Infrastructure.csproj' --context 'VpnDbContext' --no-build       | sed -n 's/^\([0-9]\{14\}[^ ]*\).*/\1/p' > "$src"

    # Applied migrations (history may not exist on fresh DB; treat as empty)
    (psql_app -Atc 'select "MigrationId" from "__EFMigrationsHistory" order by "MigrationId";' 2>/dev/null || true)       | sed '/^\s*$/d' > "$db"

    comm -23 <(sort "$src") <(sort "$db") > "$pending" || true

    echo "SOURCE_COUNT=$(wc -l <"$src" | tr -d ' ')"
    echo "APPLIED_COUNT=$(wc -l <"$db" | tr -d ' ')"
    echo "PENDING_COUNT=$(wc -l <"$pending" | tr -d ' ')"

    if [[ -s "$pending" ]]; then
      echo
      echo "Pending migrations:"
      cat "$pending"

      out_sql="/opt/vpn-service/reports/ef_idempotent_2026-01-06_13-11-33.sql"
      dotnet ef migrations script --project './VpnService.Infrastructure/VpnService.Infrastructure.csproj' --startup-project './VpnService.Infrastructure/VpnService.Infrastructure.csproj' --context 'VpnDbContext' --no-build --idempotent --output "$out_sql"
      echo "IDEMPOTENT_SQL=$out_sql"
      echo "MIGRATIONS_PENDING=YES"
    else
      echo "MIGRATIONS_PENDING=NO"
    fi
  
SOURCE_COUNT=1
APPLIED_COUNT=1
PENDING_COUNT=0
MIGRATIONS_PENDING=NO
STATUS: OK (exit=0)
----------------------------------------------------------------
>>> Summary
----------------------------------------------------------------
OK Stage 3.4 migrations CHECK PASSED (no pending).
----------------------------------------------------------------
>>> DONE
----------------------------------------------------------------
