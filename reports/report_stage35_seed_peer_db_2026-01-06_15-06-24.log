----------------------------------------------------------------
>>> Stage 3.5 â€” SEED 1 peer into DB (controlled)
----------------------------------------------------------------
----------------------------------------------------------------
>>> Load app DB env
----------------------------------------------------------------
+ CMD: bash -lc 
    cd '/opt/vpn-service'
    source scripts/lib/appdb.sh
    load_app_db_env '/opt/vpn-service/infra/local/app-db.env'
    echo "PG_DATABASE=$PG_DATABASE PG_USER=$PG_USER PG_HOST=$PG_HOST PG_PORT=$PG_PORT PG_PASSWORD=${PG_PASSWORD:+SET}"
  
PG_DATABASE=vpnservice PG_USER=vpnservice PG_HOST=127.0.0.1 PG_PORT=5432 PG_PASSWORD=SET
STATUS: OK (exit=0)
----------------------------------------------------------------
>>> Precheck: required tables exist
----------------------------------------------------------------
----------------------------------------------------------------
>>> Check public."VpnPeers" exists
----------------------------------------------------------------
+ CMD: bash -lc 
    cd '/opt/vpn-service'
    source scripts/lib/appdb.sh
    load_app_db_env '/opt/vpn-service/infra/local/app-db.env'
    psql_app -Atc "select count(*) from information_schema.tables where table_schema='public' and table_name='VpnPeers';" | grep -qx '1'
  
STATUS: OK (exit=0)
----------------------------------------------------------------
>>> Check public."VpnServers" exists
----------------------------------------------------------------
+ CMD: bash -lc 
    cd '/opt/vpn-service'
    source scripts/lib/appdb.sh
    load_app_db_env '/opt/vpn-service/infra/local/app-db.env'
    psql_app -Atc "select count(*) from information_schema.tables where table_schema='public' and table_name='VpnServers';" | grep -qx '1'
  
STATUS: OK (exit=0)
----------------------------------------------------------------
>>> Resolve VpnServerId (must exist)
----------------------------------------------------------------
VPN_SERVER_ID=01a9e169-2e7c-4e76-8272-0469d175b0f3
----------------------------------------------------------------
>>> Generate WireGuard keypair (private key stored on disk, not printed)
----------------------------------------------------------------
----------------------------------------------------------------
>>> wg genkey + pubkey
----------------------------------------------------------------
+ CMD: bash -lc 
    set -Eeuo pipefail
    priv=$(wg genkey)
    pub=$(printf '%s' "$priv" | wg pubkey)
    printf '%s
' "$priv" > "/opt/vpn-service/reports/stage35_seed_keys_2026-01-06_15-06-25/privatekey"
    chmod 600 "/opt/vpn-service/reports/stage35_seed_keys_2026-01-06_15-06-25/privatekey"
    printf '%s
' "$pub"  > "/opt/vpn-service/reports/stage35_seed_keys_2026-01-06_15-06-25/publickey"
    echo "PUBLIC_KEY=$pub"
    echo "KEY_DIR=/opt/vpn-service/reports/stage35_seed_keys_2026-01-06_15-06-25"
  
PUBLIC_KEY=QJh6h5iG80A3kvfmP46RvSR1ddBDOWV+6lMU04tNUBY=
KEY_DIR=/opt/vpn-service/reports/stage35_seed_keys_2026-01-06_15-06-25
STATUS: OK (exit=0)
----------------------------------------------------------------
>>> SAFETY GATE
----------------------------------------------------------------
Target DB: vpnservice @ 127.0.0.1:5432 user=vpnservice
This will INSERT 1 row into public."VpnPeers":
  Id=1f32ef1f-1c20-4b64-9aa9-ca103c3eaf0a
  PublicKey=QJh6h5iG80A3kvfmP46RvSR1ddBDOWV+6lMU04tNUBY
  AssignedIp=10.8.0.100
  Status=1
  VpnServerId=01a9e169-2e7c-4e76-8272-0469d175b0f3
Type SEED to continue.
----------------------------------------------------------------
>>> Insert peer (idempotent by PublicKey)
----------------------------------------------------------------
----------------------------------------------------------------
>>> INSERT if not exists
----------------------------------------------------------------
+ CMD: bash -lc 
    set -Eeuo pipefail
    cd '/opt/vpn-service'
    source scripts/lib/appdb.sh
    load_app_db_env '/opt/vpn-service/infra/local/app-db.env'

    psql_app -v ON_ERROR_STOP=1 -Atc "
      insert into public.\"VpnPeers\"(\"Id\",\"PublicKey\",\"AssignedIp\",\"Status\",\"VpnServerId\")
      select
        '1f32ef1f-1c20-4b64-9aa9-ca103c3eaf0a'::uuid,
        'QJh6h5iG80A3kvfmP46RvSR1ddBDOWV+6lMU04tNUBY',
        '10.8.0.100',
        1,
        '01a9e169-2e7c-4e76-8272-0469d175b0f3'::uuid
      where not exists (select 1 from public.\"VpnPeers\" where \"PublicKey\"='QJh6h5iG80A3kvfmP46RvSR1ddBDOWV+6lMU04tNUBY');
    "

    echo 'DB_COUNT='"$(psql_app -Atc 'select count(*) from public."VpnPeers";')"
  
INSERT 0 1
DB_COUNT=1
STATUS: OK (exit=0)
----------------------------------------------------------------
>>> DONE
----------------------------------------------------------------
SEEDED_PUBLIC_KEY=QJh6h5iG80A3kvfmP46RvSR1ddBDOWV+6lMU04tNUBY
ASSIGNED_IP=10.8.0.100
VPN_SERVER_ID=01a9e169-2e7c-4e76-8272-0469d175b0f3
KEY_DIR=/opt/vpn-service/reports/stage35_seed_keys_2026-01-06_15-06-25
