----------------------------------------------------------------
>>> Stage 3.4 — MIGRATIONS APPLY (build + update)
----------------------------------------------------------------
REPO_ROOT=/opt/vpn-service
REPORT_FILE=/opt/vpn-service/reports/report_stage34_migrations_apply_2026-01-06_13-03-42.log
CTX=VpnDbContext

----------------------------------------------------------------
>>> dotnet ef --version
----------------------------------------------------------------
CMD: bash -lc cd '/opt/vpn-service' && dotnet ef --version
Entity Framework Core .NET Command-line Tools
9.0.11
STATUS: 0
----------------------------------------------------------------
>>> DB app connect: SELECT 1
----------------------------------------------------------------
CMD: bash -lc 
    cd '/opt/vpn-service'
    source scripts/lib/appdb.sh
    load_app_db_env '/opt/vpn-service/infra/local/app-db.env'
    psql_app -Atc 'select 1;'
  
1
STATUS: 0
----------------------------------------------------------------
>>> EF migrations list (source, explicit context)
----------------------------------------------------------------
CMD: bash -lc 
    cd '/opt/vpn-service'
    source scripts/lib/appdb.sh
    load_app_db_env '/opt/vpn-service/infra/local/app-db.env'
    dotnet ef migrations list --project './VpnService.Infrastructure/VpnService.Infrastructure.csproj' --startup-project './VpnService.Infrastructure/VpnService.Infrastructure.csproj' --context 'VpnDbContext'
  
Build started...
Build succeeded.
Failed executing DbCommand (24ms) [Parameters=[], CommandType='Text', CommandTimeout='30']
SELECT "MigrationId", "ProductVersion"
FROM "__EFMigrationsHistory"
ORDER BY "MigrationId";
20260106130133_Initial_20260106_130108 (Pending)
STATUS: 0
----------------------------------------------------------------
>>> SAFETY GATE
----------------------------------------------------------------
Target DB: vpnservice @ 127.0.0.1:5432 user=vpnservice
Project: ./VpnService.Infrastructure/VpnService.Infrastructure.csproj
Context: VpnDbContext
This step will BUILD and APPLY migrations.
Type APPLY to continue.
----------------------------------------------------------------
>>> dotnet build (required to avoid PendingModelChanges with --no-build)
----------------------------------------------------------------
CMD: bash -lc 
    set -Eeuo pipefail
    cd '/opt/vpn-service'
    dotnet build './VpnService.Infrastructure/VpnService.Infrastructure.csproj' -c Debug
  
  Определение проектов для восстановления...
  Все проекты обновлены для восстановления.
  VpnService.Domain -> /opt/vpn-service/VpnService.Domain/bin/Debug/net9.0/VpnService.Domain.dll
  VpnService.Infrastructure.Abstractions -> /opt/vpn-service/VpnService.Infrastructure.Abstractions/bin/Debug/net9.0/VpnService.Infrastructure.Abstractions.dll
  VpnService.Application -> /opt/vpn-service/VpnService.Application/bin/Debug/net9.0/VpnService.Application.dll
  VpnService.Infrastructure -> /opt/vpn-service/VpnService.Infrastructure/bin/Debug/net9.0/VpnService.Infrastructure.dll

Сборка успешно завершена.
    Предупреждений: 0
    Ошибок: 0

Прошло времени 00:00:02.54
STATUS: 0
----------------------------------------------------------------
>>> EF database update (apply migrations) [NO --no-build]
----------------------------------------------------------------
CMD: bash -lc 
    set -Eeuo pipefail
    cd '/opt/vpn-service'
    source scripts/lib/appdb.sh
    load_app_db_env '/opt/vpn-service/infra/local/app-db.env'
    CONN="$(app_conn_str)"
    dotnet ef database update --project './VpnService.Infrastructure/VpnService.Infrastructure.csproj' --startup-project './VpnService.Infrastructure/VpnService.Infrastructure.csproj' --context 'VpnDbContext' --connection "$CONN"
  
Build started...
Build succeeded.
Failed executing DbCommand (33ms) [Parameters=[], CommandType='Text', CommandTimeout='30']
SELECT "MigrationId", "ProductVersion"
FROM "__EFMigrationsHistory"
ORDER BY "MigrationId";
Acquiring an exclusive lock for migration application. See https://aka.ms/efcore-docs-migrations-lock for more information if this takes too long.
Applying migration '20260106130133_Initial_20260106_130108'.
Done.
STATUS: 0
----------------------------------------------------------------
>>> DB: __EFMigrationsHistory after apply
----------------------------------------------------------------
CMD: bash -lc 
    cd '/opt/vpn-service'
    source scripts/lib/appdb.sh
    load_app_db_env '/opt/vpn-service/infra/local/app-db.env'
    psql_app -Atc 'select migrationid, productversion from "__EFMigrationsHistory" order by migrationid;'
  
ERROR:  column "migrationid" does not exist
СТРОКА 1: select migrationid, productversion from "__EFMigrationsHisto...
                 ^
ПОДСКАЗКА:  Perhaps you meant to reference the column "__EFMigrationsHistory.MigrationId".
STATUS: 1
----------------------------------------------------------------
>>> Summary
----------------------------------------------------------------
OK migrations applied.
Done. Report saved: /opt/vpn-service/reports/report_stage34_migrations_apply_2026-01-06_13-03-42.log
